# Ver.BETA ビルドガイド
BETA基板と以降の基板の互換性はありません。パネルの寸法も変わっています。ご注意ください。

## 作業前の準備
### 内容物の確認
 - 基板  
   1枚入っています。
 - スイッチプレート  
   1枚入っています。
 - バックプレート  
   1枚入っています。  
 - ゴム足  
   4枚入っています。
 - ネジ・スペーサー  
   M2のネジが長短10本ずつ、スペーサーが長短10本ずつ入っています。
 - 加工済みMXキーソケット
   Kailh製キーソケットを加工したものになります。2つ入っています。※「既知の問題の確認」参照
### 必須パーツの用意
 - Pro Micro  
   1個
   ※「Pro Microの選定・動作確認」参照
 - ピンソケット  
   2本 3.5mm、13Pin推奨 2.54mmピッチ
 - ピンヘッダ  
   2本 2.5mm、1x12pinまたは1x13pin 2.54mmピッチ
   ※「Pro Microの選定・動作確認」参照
 - Cherry MX互換キースイッチ
   72個
 - MX軸キーキャップ  
   1セット JIS配列推奨
   ※「キーキャップの選定」参照
 - タクトスイッチ  
   1個
 - MXキーソケット  
   70個 Kailh製のものを想定しています。
 - ダイオード  
   72個 1N4148 リードまたは表面実装
 - MX用 2Uスタビライザー  
   3個
### 必須工具類
 - はんだ作業関連品一式
 - 六角レンチ
 - エンドニッパー
 - Pro Microに対応する通信用ケーブル
### 推奨工具類
 - キープラー
 - 油性マーカー(黒)
 - マスキングテープ
### 必要ファイルのダウンロード
 - childhood_s_end_via-****.hex
 - childhood_s_end_via-****.json
 - info-****.json
  
## キーキャップの選定
以下の条件を満たすJIS配列用のセットであれば主要なキーをカバーできます。  
 - 65%以上のセット
 - Stepped Caps Lock (1.5U)   

最下段の構成は以下の通りです。
 - 1.5U Ctrl
 - 1.25U Win
 - 1.25U Alt
 - 1U 無変換
 - 2U Space
 - 1.5U Space
 - 1.25U 変換
 - 1.25U かな
 - 1.25U Alt
 - 1.25U Menu
 - 1.5U Ctrl
    
単品購入が必要だったり、移植する必要がある可能性の高いキーは以下の通りです。
 - 右ShiftおよびFn  
   1U @R2が必要です。同列のテンキーや矢印キー上を使用するか、ブランクを購入してください。  
 - Space  
   左側に2U @R1、右側に1.5U @R1を使用します。  
 - 左Shift  
   2U @R1が必要です。
  
その他のキーも足りない場合は適宜単品購入して合わせます。

[具体的なキー幅はKLEでも確認できます。右上の番号は基板の番号と対応しています。](http://www.keyboard-layout-editor.com/##@@_y:2&x:2%3B&=%0AEsc%0A1&_x:0.5%3B&=%0AIns%0A2&=%0APrint%0A3&=%0AScLk%0A4&=%0APause%0A5&_x:5.75%3B&=%0A%2F=-%0A59&=%0A~%5E%0A64&=%0A%7C%5C%0A69&=%0ABS%0A72%3B&@_x:12.75%3B&=%0AP%0A55&=%0A%60%2F@%0A60&=%0A%7B%5B%0A65&_x:0.25&w:1.25&h:2&w2:1.5&h2:1&x2:-0.25%3B&=%0AEnter%0A70%0A%0A%0A%0A%0A%0A%0AISO%3B&@_y:-0.75&x:2%3B&=%0A%E5%8D%8A%2F%2F%E5%85%A8%0A6&=%0A1%0A11&=%0A2%0A16&=%0A3%0A21&=%0A4%0A26&=%0A5%0A31%3B&@_y:-0.25&x:13%3B&=%0A%2F%3B+%0A56&=%0A%2F:%0A61&=%0A%7D%5D%0A66%3B&@_y:-0.75&x:2&w:1.5%3B&=%0ATab%0A7%0A%0A%0A%0A%0A%0A%0A1.5&=%0AQ%0A12&=%0AW%0A17&=%0AE%0A22&=%0AR%0A27&=%0AT%0A32%3B&@_y:-0.25&x:13.25%3B&=%0A%3F%2F%2F%0A57&=%0A%2F_%5C%0A62&=%0AShiftR%0A67&=%0AFn%0A71%3B&@_y:-0.75&x:2&w:1.5&w2:1.75&l:true%3B&=%0ACaps%20Lock%0A8%0A%0A%0A%0A%0A%0A%0A1.75%20Step&_x:0.25%3B&=%0AA%0A13&=%0AS%0A18&=%0AD%0A23&=%0AF%0A28%0A%0A%0A%0A%0A%0A%0A%0A%2F_&=%0AG%0A33%3B&@_y:-0.25&x:13.25&w:1.25%3B&=%0AAltR%0A58%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.25%3B&=%0AMenu%0A63%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.5%3B&=%0ACtrlR%0A68%0A%0A%0A%0A%0A%0A%0A1.5%3B&@_y:-0.75&x:2&w:2%3B&=%0AShiftL%0A9%0A%0A%0A%0A%0A%0A%0A2&=%0AZ%0A14&=%0AX%0A19&=%0AC%0A24&=%0AV%0A29&=%0AB%0A34%3B&@_x:2&w:1.5%3B&=%0ACtrlL%0A10%0A%0A%0A%0A%0A%0A%0A1.5&_w:1.25%3B&=%0AWin%0A15%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.25%3B&=%0AAltL%0A20%0A%0A%0A%0A%0A%0A%0A1.25&=%0A%E7%84%A1%E5%A4%89%E6%8F%9B%0A25&_w:2%3B&=%0A%0A30%0A%0A%0A%0A%0A%0A%0A2%3B&@_rx:12&ry:4.75&y:-2.75&x:0.25%3B&=%0A0%0A54%3B&@_r:-14.4&y:-0.75&x:-3.5%3B&=%0A6%0A35&=%0A7%0A40&=%0A8%0A44&=%0A9%0A49%3B&@_x:-3.25%3B&=%0AY%0A36&=%0AU%0A41&=%0AI%0A45&=%0AO%0A50%3B&@_x:-3.25%3B&=%0AH%0A37&=%0AJ%0A42%0A%0A%0A%0A%0A%0A%0A%0A%2F_&=%0AK%0A46&=%0AL%0A51%3B&@_x:-3.25%3B&=%0AN%0A38&=%0AM%0A43&=%0A%3C,%0A47&=%0A%3E.%0A52%3B&@_x:-3.5&w:1.5%3B&=%0A%0A39%0A%0A%0A%0A%0A%0A%0A1.5&_w:1.25%3B&=%0A%E5%A4%89%E6%8F%9B%0A48%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.25%3B&=%0A%E3%82%AB%E3%81%B2%E3%83%AD%0A53%0A%0A%0A%0A%0A%0A%0A1.25)

## Pro Microの選定・動作確認
### 選定
ATmega32U4を搭載したPro Micro互換基板であれば基本的に使用可能です。  
類似品としてICチップが異なるRP2040版がありますが、現在のファームウェアに互換性はなく、使用できないのでご注意ください。  
また、BETA基板には無線化対応を行いません。悪しからずご了承ください。

### 部品類
ピンソケット・ピンヘッダが必要です。  
「必須パーツの用意」で書いた通りの仕様であれば問題なく使えるはずです。  
一度組み上げた後のピンソケットの交換は非常に面倒なので、1x13pinを推奨しています。  
ピンヘッダのピン数はPro Microのピン数に合わせてください。  

### 動作確認
![キーボードのプログラムです](img/VIA1.jpg)  
現在のところVIAやReMapなどにはマージされていません。Pro Micro Web Updaterを用いてPro Microにファームウェア(childhood_s_end_via-BETA.hex)を書き込んでください。  
一旦書き込んだらReMapおよびVIAによる編集が可能になります。  
<details><summary>うまくいかない場合</summary>
  通信用ケーブルで接続していること、ChromeでUpdaterを開いていることを確認してください。  
  それでも認識しなかったり、書き込めない場合は初期不良かもしれません。
</details>  


## ファイルの確認  
全て本リポジトリ内の/Firm/ver-beta/以下で入手できます。
### [childhood_s_end_via-BETA.hex](Childhood-s-End/Firm/ver-beta/childhood_s_end_via-BETA.hex)
キーボードを制御するためのファームウェアです。
### [childhood_s_end_via-BETA.json](Childhood-s-End/Firm/ver-beta/childhood_s_end_via-BETA.json)
VIA用の初期キーマップ定義用ファイルです。ファームウェアだけではキーマップが崩れてしまうため、VIA経由で定義し直す用です。
### [info-BETA.json](Childhood-s-End/FIrm/ver-beta/info-beta.json)
キーマトリクス定義用ファイルです。現状ではVIAやReMapでキーマップを書き換える度に使用することになります。


## はんだ前の作業
### 既知の問題の確認
確認の上対応をお願いします。  

 - ピンソケットとスイッチソケットの干渉
   工作精度の問題およびパーツの嵌合の相性により、SW1とSW2のスイッチソケットとピンソケットが干渉して斜めになってしまうことがあります。
   はんだづけ前にはめ合いを確認し、両方が正しく垂直に刺さっている状態になるように調整をお願いします。
   付属の加工済みスイッチソケットを使用したうえで、ピンソケットの上下を入れ替えることで改善できます。  

 - スペーサーとピンソケットの干渉
   工作精度の問題およびパーツの嵌合の相性により、スペーサーとピンソケットが干渉して入らない、あるいは斜めになってしまうことがあります。
   ピンソケットと六角スペーサーの辺が平行になるようにねじ止めすることで回避できます。
   
 - LEDの給電に関する問題およびVCC(動力線)の潜在的な問題
   現在のところ、原因は不明ながらLEDが点灯しません。実装して点灯しなかった場合でもサポートはできません。
   また、一部のVCC(電力線)が他と比べて細くなってしまっているようです。
   致命的な症状ではないものの、LEDを実装した状態では通電してしまうため、潜在的な問題となっています。  

ご迷惑をおかけして申し訳ございません。

### 基板端の処理(任意)
基板の端(断面)を油性マーカーで塗ると綺麗に見えます。

### MogeMicroの予防(任意)
Pro MicroのUSB端子部にエポキシ樹脂などを盛ることで端子もげを予防します。  
特にMicro-B端子のものはもげやすいのでやっておくと安心して使用できます。

## 部品のはんだづけ
ここから先は大量のパーツをはんだづけすることになります。  
途中で休憩もできますが、一度にやってしまうのが楽でしょう。  

### ダイオードのはんだづけ
![スイッチの誤作動を予防します](img/diode.jpg)  
1N4148シリーズの使用を想定しています。表面実装、リード、どちらでも問題ありません。  
向きは基本的に左向きに揃えてあります。D1、D2、D30のみ下向きです。  
シルクスクリーンとダイオードの線を揃えてはんだづけしてください。

### スイッチソケットのはんだづけ
![スイッチの簡単な交換を実現するパーツです](img/socket.jpg)  
シルクスクリーンとソケットの向きを揃えてはんだづけしてください。  
あまり大量にはんだを流すと端子部だけでなくソケット部にまで流れ込み、押し込みが硬くなったり差し込めなくなってしまうので注意してください。  
SW1とSW2には付属の加工済みスイッチソケットを使用し、ピンソケットを仮置きして干渉しないことを確認してからはんだづけしてください。

### タクトスイッチのはんだづけ
![いわゆるリセットボタンです](img/reset.jpg)  
頻繁に使うものではありませんが、筐体を分解せずにリセットを行うために必須となります。  
向きはないので、シルクスクリーンに合わせて差し込み、はんだづけします。

### ピンソケット・ピンヘッダの作業
![Pro Microの修理を簡単にします](img/pin.jpg)  
<details><summary>エンドニッパーを持っていない場合、Pro Microのはんだづけより先に読むべき説明</summary>
  先にピンヘッダを切ってしまい、Pro Microの基板とツライチになるように調整してからはんだを流すことでピンの飛び出しを少なくすることができます。
  もし既にはんだづけを行ってしまい、飛び出しが大きい場合は、スペーサーを購入して入れ替えるか、基板をマスキングテープで保護したうえではんだをヤスリで少しずつそぎ落としてください。
</details>  

基板裏側からピンソケットを刺し、マスキングテープなどで固定してはんだづけします。  
ここにピンヘッダを刺し、Pro Microを通してPro Microとヘッダをはんだづけします。  

ピンソケットとピンヘッダの余ったピン部分をエンドニッパーで落とします。バックパネルとのクリアランスは約0.3mmになるため、ギリギリを狙って切ってください。  
ピンヘッダとPro Microの作業はブレッドボード上で行ってもいいでしょう。  

一度Pro Microを取り外します。

## 部品の取付け
### スタビライザーの静音化(任意)
![グリスを塗ります](img/stablube.jpg)  
スタビライザーを分解して摺動部とワイヤーの端をたっぷりのグリスでコーティングします。  
![テープを下敷きにします](img/stabmask/jpg)  
スタビライザーの足元(穴と穴のあいだ)にマスキングテープや不織布テープを貼ります。  
枚数は基板との隙間によりけり。多すぎると固定用の爪が噛まなくなるので適度にゲタを履かせましょう。

### スタビライザーの取付け
![スタビライザーをはめ込みます](img/stab.jpg)  
ワイヤーが露出する部分は基板上に線で表示されています。  
左Shiftに右Shiftのキャップを移植する際は左Shiftのスタビライザーは不要です。

### スペーサーの取付け
![好きな数使用しましょう](img/spacer.jpg)
スイッチプレートの表からM2x10のネジを通します。この状態で裏から3.5mmスペーサーを取り付けます。  
基板の穴を合わせてはめ込み、8mmスペーサーを入れて固定します。

### スイッチの取付け
![スイッチをはめます](img/switch.jpg)  
スイッチプレートを正面から見て、足が下側になるようにスイッチを取り付けます。  
どこから作業を始めても問題ありませんが、スペーサーの近くから始めるとプレートが安定します。  
スイッチの爪が十分に掛かっていないと脱落の原因になるので、時々スイッチプレートを引き上げてしっかり固定されるようにしてください。
※スイッチの足が曲がったままソケットに挿入しようとすると破損してしまうので、プレートに対してスイッチと足の両方が垂直になるように挿入しましょう。  
※一度はんだを付けたことのあるスイッチや、足が折れたのを曲げ戻したスイッチは使用しないことをお勧めします。

## スイッチの確認
![部品が生きているかを確認します](img/VIA2.jpg)  
スイッチを全て取り付けたらReMap経由でスイッチをテストします。  
キーマップとしてinfo-****.jsonを読み込み、Test Matrix Modeでキーの認識を見ましょう。
<details><summary>VIAの場合</summary>SettingsからShow Design Tabをオンにします。Design > Load Draft Definition からinfo-****.jsonをロードして使用します。Key Tester > Test Matrix でTest Matrix Modeに移動できます。</details>  
<details><summary>ReMapの場合</summary>キーボードを接続した時点で.jsonファイルを要求されます。info-****.jsonをロードして使用してください。  右下の三点メニューからTest Matrix Modeを起動できます。</details>
単独で認識がおかしいキーがあった場合はスイッチの足が曲がっていないか、スイッチソケットの足とダイオードははんだづけされているか、ダイオードの向きは合っているかを確認します。  
列単位・行単位で反応しない場合はPro Microとソケット部のはんだを確認してください。  

すべてのキーに間違いなく反応したら、このキーボードは入力機器として認識できる状態になっています。

## バックパネルの取付け
![ほとんど完成です](img/backpanel.jpg)  
バックパネルを基板の裏に載せ、ネジで固定します。

## ゴム足の取付け
![すべり止めになります](img/rubbersole.jpg)
パネルの表示に合わせてゴム足を取り付けます。

# マッピングガイド
キーマップの書き換えにはReMapを使用します。日本語配列にも対応しているため使いやすいと思います。  

## 初期状態
デフォルトで設定されているのはJIS配列を踏襲した配置となっており、通常のJISキーボードからの移行でも違和感なく使用できるはずです。  

Fnキーを押したときの挙動はレイヤーとして扱っています。初期状態では1から^までのキーにF1からF12を割り振り、さらにBackspaceにDeleteを設定している状態です。  
左上のエリア、Esc以外の4キーは初期状態では空になっています。好みのマクロやキーを設定してください。

## 書き換え
「スイッチの確認」と同じ手順でReMapに接続し、変更したいキーを選択して書き換えます。
