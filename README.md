Build guide for Childhood's End  
「幼年期の終わり」ビルドガイド
----------------------------
Half-Alice style keyboard

![Caseless Ver.](img/CE-1.jpg)
![Cased Ver.](img/CE-2.jpg)

# 設計思想
幼年期の終わり(Childhood's End)は、ノートパソコンの筐体中央とホームポジションが揃っていないという問題点を解決しつつ、コンパクトに使えるキーボードとして設計されました。  
本キーボードの主な特徴は右手クラスタの傾斜配置とJIS配列にあり、ノートパソコンのキーボードの上に乗せて使用することを想定しています。  
  
キーを傾斜させる配置では左右対称に近いデザインにすることが多い一方、本キーボードは右手側だけを大きく傾斜させています。  
これにより、左手をまっすぐ、右手を斜めに置いて打鍵する左右非対称の姿勢でも打ちやすい独特の使い心地が生まれます。  
  
また、日本語入力にはほぼ必須ともいえる全角半角キー、変換無変換や片仮名ひらがなローマ字といったキーも詰め込まれています。  
自作キーボードの世界では数少ない片側のみの傾斜配置、JIS配列を組み合わせた特徴的なキーボードをお楽しみください。

# ビルドガイド

## 作業前の準備
### 内容物の確認
 - 基板  
   1枚入っています。
 - スイッチプレート  
   1枚入っています。
 - バックプレート  
   1枚入っています。  
 - ゴム足  
   4枚入っています。
### 必須パーツの用意
 - Pro Micro  
   1個
   ※「Pro Microの選定・動作確認」参照
 - ピンソケット  
   2本 3.5mm、13Pin推奨 2.54mmピッチ
 - ピンヘッダ  
   2本 2.5mm、1x12pinまたは1x13pin 2.54mmピッチ
   ※「Pro Microの選定・動作確認」参照
 - Cherry MX互換キースイッチ
   72個
 - MX軸キーキャップ  
   1セット JIS配列推奨
   ※「キーキャップの選定」参照
 - タクトスイッチ  
   1個
 - MXキーソケット  
   72個 Kailh製のものを想定しています。
 - ダイオード  
   72個 1N4148 リードまたは表面実装
 - MX用 2Uスタビライザー  
   2~3個
   ※「キーキャップの選定」参照
 - M2スペーサー  
   3mm、8mmメスメスが最低4本ずつ必要です。最大で18本ずつ使用できます。
   ※「スペーサーの選定」参照
 - M2ネジ  
   10mmと5mmがそれぞれスペーサーの数だけ必要です。
   例えば、3mmを10本、8mmを10本使用する場合は10mmが10本、5mmが10本必要です。
### その他パーツの用意※必須ではない
 - LED
   72個 SK6812MINI-E
### 必須工具類
 - はんだ作業関連品一式
 - 六角レンチ
 - エンドニッパー
 - Pro Microに対応する通信用ケーブル
### 推奨工具類
 - キープラー
 - 油性マーカー(黒)
 - マスキングテープ
### 必要ファイルのダウンロード
 - childhood_s_end_via-****.hex
 - childhood_s_end_via-****.json
 - info-****.json
  
## キーキャップの選定
以下の条件を満たすJIS配列用のセットであればほぼ全てのキーをカバーできます。  
 - 65%以上のセット
 - Stepped Caps Lock (1.5U-1.75U)  
最下段の構成は以下の通りです。
 - 1.5U Ctrl
 - 1.25U Win
 - 1.25U Alt
 - 1U 無変換
 - 2U Space
 - 1.5U Space
 - 1.25U 変換
 - 1.25U かな
 - 1.25U Alt
 - 1.25U Menu
 - 1.5U Ctrl
    
単品購入が必要だったり、移植する必要がある可能性の高いキーは以下の通りです。
 - 右ShiftおよびFn  
   1U @R2が必要です。同列のテンキーや矢印キー上を使用するか、ブランクを購入してください。  
 - Space  
   左側に2U @R1、右側に1.5U @R1を使用します。2Uの方はテンキーの0が使用可能です。  
 - 左Shift  
   後述のスタビライザーを導入の上で2U @R2のキーキャップを使用するか、スタビライザーを取り付けずに右Shift(1.75U @R2)のキャップを移植してください。  
  
その他のキーも足りない場合は適宜単品購入して合わせます。
  
 - 左Shiftキーに1.75Uキーキャップを使用する場合は必要なスタビライザーの合計数は2個、2Uを使用する場合は3個となります。
 - スナップオンタイプ、ねじ止めタイプ、どちらも使用可能です。スイッチプレート実装型のものは使用できません(そもそも流通が少ないのでうっかりでは使わないと思いますが……)

[具体的なキー幅はKLEでも確認できます。](http://www.keyboard-layout-editor.com/##@@_y:2&x:2%3B&=%0AEsc&_x:0.5%3B&=%0AM1&=%0AM2&=%0AM3&=%0AM4&_x:5.75%3B&=%0A%2F=-&=%0A~%5E&=%0A%7C%5C&=%0ABS%3B&@_x:12.75%3B&=%0AP&=%0A%60%2F@&=%0A%7B%5B&_x:0.25&w:1.25&h:2&w2:1.5&h2:1&x2:-0.25%3B&=%0AEnter%0A%0A%0A%0A%0A%0A%0A%0AISO%3B&@_y:-0.75&x:2%3B&=%0A%E5%8D%8A%2F%2F%E5%85%A8&=%0A1&=%0A2&=%0A3&=%0A4&=%0A5%3B&@_y:-0.25&x:13%3B&=%0A%2F%3B+&=%0A%2F:&=%0A%7D%5D%3B&@_y:-0.75&x:2&w:1.5%3B&=%0ATab%0A%0A%0A%0A%0A%0A%0A%0A1.5&=%0AQ&=%0AW&=%0AE&=%0AR&=%0AT%3B&@_y:-0.25&x:13.25%3B&=%0A%3F%2F%2F&=%0A%2F_%5C&=%0AShiftR&=%0AFn%3B&@_y:-0.75&x:2&w:1.5&w2:1.75&l:true%3B&=%0ACaps%20Lock%0A%0A%0A%0A%0A%0A%0A%0A1.75%20Step&_x:0.25%3B&=%0AA&=%0AS&=%0AD&=%0AF%0A%0A%0A%0A%0A%0A%0A%0A%0A%2F_&=%0AG%3B&@_y:-0.25&x:13.25&w:1.25%3B&=%0AAltR%0A%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.25%3B&=%0AMenu%0A%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.5%3B&=%0ACtrlR%0A%0A%0A%0A%0A%0A%0A%0A1.5%3B&@_y:-0.75&x:2&w:2%3B&=%0AShiftL%0A%0A%0A%0A%0A%0A%0A%0A2&=%0AZ&=%0AX&=%0AC&=%0AV&=%0AB%3B&@_x:2&w:1.5%3B&=%0ACtrlL%0A%0A%0A%0A%0A%0A%0A%0A1.5&_w:1.25%3B&=%0AWin%0A%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.25%3B&=%0AAltL%0A%0A%0A%0A%0A%0A%0A%0A1.25&=%0A%E7%84%A1%E5%A4%89%E6%8F%9B&_a:7&w:2%3B&=2%3B&@_rx:12&ry:4.75&y:-2.75&x:0.25&a:4%3B&=%0A0%3B&@_r:-14.4&y:-0.75&x:-3.5%3B&=%0A6&=%0A7&=%0A8&=%0A9%3B&@_x:-3.25%3B&=%0AY&=%0AU&=%0AI&=%0AO%3B&@_x:-3.25%3B&=%0AH&=%0AJ%0A%0A%0A%0A%0A%0A%0A%0A%0A%2F_&=%0AK&=%0AL%3B&@_x:-3.25%3B&=%0AN&=%0AM&=%0A%3C,&=%0A%3E.%3B&@_x:-3.5&a:7&w:1.5%3B&=1.5&_a:4&w:1.25%3B&=%0A%E5%A4%89%E6%8F%9B%0A%0A%0A%0A%0A%0A%0A%0A1.25&_w:1.25%3B&=%0A%E3%82%AB%E3%81%B2%E3%83%AD%0A%0A%0A%0A%0A%0A%0A%0A1.25)


## スペーサーの選定
M2規格のものを使用します。  
3mmスペーサーはM2のねじが切られたメスメスを使用するか、M2通し穴タイプがあるならそちらも使用できます。  
8mmスペーサーは固定に使用するため、M2のねじ切りが必要です。こちらもメスメスを使用します。  

基板とプレート2枚をスペーサーで固定する構造を取っているため、固定する位置により打鍵感を調整することができます。  
また、スペーサーを増やせば増やすほど剛性(ねじれ・曲がり耐性)が向上するため、強度のあるキーボードにすることができます。
必須となるのは隅の4か所で、加えて上下の4か所、Caps Lockの右側、Enterの左側、傾斜部の両側6か所、上部クラスタの下側2か所を固定することができます。  
<details><summary>スペーサー全然売ってないよ！</summary>
  1.6mm厚のM2ナット(1種・2種規格品)を2枚重ねることで3.2mmの厚みになります。5枚重ねれば8mmになります。
  この場合、ネジはM2x17またはM2x18を使用できます(ただし、裏から飛び出します)。
  製造誤差によっては全体に最大で2mm程度の誤差が出てしまうので、この部分は組み合わせの変更やねじの長さの調整を行ってください。
  また、スペーサー最大数をナットのみで達成しようとすると126枚必要になるため、購入時には数量に注意してください。
</details>
  
購入難易度まで加味したおすすめの配置は以下の通りです。


## Pro Microの選定・動作確認
### 選定
ATmega32U4を搭載したPro Micro互換基板であれば基本的に使用可能です。  
類似品としてICチップが異なるRP2040版がありますが、現在のファームウェアに互換性はなく、使用できないのでご注意ください。  
また、現在のところでは無線化(BLE Micro Pro)をサポートしていませんが、将来電池ボックス等を実装する可能性があります。  

### 部品類
ピンソケット・ピンヘッダが必要です。  
「必須パーツの用意」で書いた通りの仕様であれば問題なく使えるはずです。  
一度組み上げた後のピンソケットの交換は非常に面倒なので、1x13pinを推奨しています。  
ピンヘッダのピン数はPro Microのピン数に合わせてください。  

### 動作確認
![キーボードのプログラムです](img/VIA1.jpg)  
現在のところVIAやReMapなどにはマージされていません。Pro Micro Web Updaterを用いてPro Microにファームウェア(childhood_s_end_via-****.hex)を書き込んでください。  
一旦書き込んだらReMapおよびVIAによる編集が可能になります。  
<details><summary>うまくいかない場合</summary>
  通信用ケーブルで接続していること、ChromeでUpdaterを開いていることを確認してください。  
  それでも認識しなかったり、書き込めない場合は初期不良かもしれません。
</details>  


## ファイルの確認
ファイル名末尾の **** の部分はバージョン情報です。特別な理由がない限り最新のものを使用してください。  
全て本リポジトリ内の/Firm/Ver-****/以下で入手できます。
### childhood_s_end_via-****.hex
キーボードを制御するためのファームウェアです。
### childhood_s_end_via-****.json
VIA用の初期キーマップ定義用ファイルです。ファームウェアだけではキーマップが崩れてしまうことがあるため、VIA経由で定義し直す用です。
### info-****.json
キーマトリクス定義用ファイルです。VIAやReMapでキーマップを書き換える度に使用します。


## はんだ前の作業
### 既知の問題の確認
以下のバージョンでは問題点が発見されています。確認の上対応をお願いします。  
 - Ver.BETA
<details><summary>ピンソケットとスイッチソケットの干渉</summary>
工作精度の問題およびパーツの嵌合の相性により、SW1とSW2のスイッチソケットとピンソケットが干渉してどちらかが斜めになってしまうことがあります。  
  はんだづけ前にはめ合いを確認し、両方が正しく垂直に刺さっている状態になるように調整をお願いします。  
  ピンソケットの向きにより干渉の度合いが改善することがあります。それでも垂直にならない場合はスイッチソケットを削ることで対処します。
</details>  
<details><summary>スペーサーとスイッチソケットの干渉</summary>
スペーサーの形状により、傾斜部クラスタのEnterキー側のスペーサーとスイッチソケット(のはんだ)が干渉してしまうことがあります。  
六角スペーサーであればはんだを回避するように回転を調整して固定できますが、円形スペーサーの場合ははんだを最小限に抑えて固定してください。  
</details>  
<details><summary>VCC(動力線)の潜在的な問題</summary>
一部のVCCの設定ミスにより、L21~26の配線に強い負荷がかかっていると予想されます。確実に不具合が起きるものではありませんが、万一該当部に問題が発生した場合はサポートを行います。
</details>
ご迷惑をおかけして申し訳ございません。

### 基板端の処理(任意)
基板の端(断面)を油性マーカーで塗ると綺麗に見えます。


## 部品のはんだづけ
ここから先は大量のパーツをはんだづけすることになります。  
途中で休憩もできますが、一度にやってしまうのが楽でしょう。

### LEDのはんだづけ(オプション)
![1677万7216色に光ります](img/LED.jpg)  
表面実装LEDは全て付けるか付けないかの二択になります。  
LEDの発光面を表側に向け、基板の表示(シルクスクリーン)上のGNDとLEDの足の切り欠きを合わせてはんだづけしていきます。  
後で作業しようとすると大変なので、付けたい場合は最初に付けてください。  
  
低融点の有鉛はんだを使うのがお勧めです。煙を吸わないよう換気・送風を行ってください。  

### ダイオードのはんだづけ
![スイッチの誤作動を予防します](img/diode.jpg)  
1N4148シリーズの使用を想定しています。表面実装、リード、どちらでも問題ありません。  
向きは基本的に左向きに揃えてあります。D1、D2、D30のみ下向きです。  
シルクスクリーンとダイオードの線を揃えてはんだづけしてください。

### スイッチソケットのはんだづけ
![スイッチの簡単な交換を実現するパーツです](img/socket.jpg)  
シルクスクリーンとソケットの向きを揃えてはんだづけしてください。  
あまり大量にはんだを流すと端子部だけでなくソケット部にまで流れ込み、押し込みが硬くなったり差し込めなくなってしまうので注意してください。

### タクトスイッチのはんだづけ
![いわゆるリセットボタンです](img/reset.jpg)  
頻繁に使うものではありませんが、筐体を分解せずにリセットを行うために必須となります。  
向きはないので、シルクスクリーンに合わせて差し込み、はんだづけします。

### ピンソケット・ピンヘッダの作業
![Pro Microの修理を簡単にします](img/pin.jpg)  
<details><summary>エンドニッパーを持っていない場合、Pro Microのはんだづけより先に読むべき説明</summary>
  先にピンヘッダを切ってしまい、Pro Microの基板とツライチになるように調整してからはんだを流すことでピンの飛び出しを少なくすることができます。
  もし既にはんだづけを行ってしまい、飛び出しが大きい場合は、スペーサーを購入して入れ替えるか、基板をマスキングテープで保護したうえではんだをヤスリで少しずつそぎ落としてください。
</details>  

基板裏側からピンソケットを刺し、マスキングテープなどで固定してはんだづけします。  
ここにピンヘッダを刺し、Pro Microを通してPro Microとヘッダをはんだづけします。  

ピンソケットとピンヘッダの余ったピン部分をエンドニッパーで落とします。バックパネルとのクリアランスは約0.3mmになるため、ギリギリを狙って切ってください。  
ピンヘッダとPro Microの作業はブレッドボード上で行ってもいいでしょう。

## 部品の取付け
### スタビライザーの静音化(任意)
![グリスを塗ります](img/stablube.jpg)  
スタビライザーを分解して摺動部とワイヤーの端をたっぷりのグリスでコーティングします。  
![テープを下敷きにします](img/stabmask/jpg)  
スタビライザーの足元(穴と穴のあいだ)にマスキングテープや不織布テープを貼ります。  
枚数は基板との隙間によりけり。多すぎると固定用の爪が噛まなくなるので適度にゲタを履かせましょう。

### スタビライザーの取付け
![スタビライザーをはめ込みます](img/stab.jpg)  
ワイヤーが露出する部分は基板上に線で表示されています。  
左Shiftに右Shiftのキャップを移植する際は左Shiftのスタビライザーは不要です。

### スペーサーの取付け
![好きな数使用しましょう](img/spacer.jpg)
スイッチプレートの表からM2x10のネジを通します。この状態で裏から3mmスペーサーを取り付けます。  
基板の穴を合わせてはめ込み、8mmスペーサーを入れて固定します。

### スイッチの取付け
![スイッチをはめます](img/switch.jpg)  
スイッチプレートを正面から見て、足が下側になるようにスイッチを取り付けます。  
どこから作業を始めても問題ありませんが、スペーサーの近くから始めるとプレートが安定します。  
※スイッチの足が曲がったままソケットに挿入しようとすると破損してしまうので、プレートに対してスイッチと足の両方が垂直になるように挿入しましょう。  
※一度はんだを付けたことのあるスイッチや、足が折れたのを曲げ戻したスイッチは使用しないことをお勧めします。

## スイッチの確認
![部品が生きているかを確認します](img/VIA2.jpg)  
スイッチを全て取り付けたらReMap経由でスイッチをテストします。  
キーマップとしてinfo-****.jsonを読み込み、Test Matrix Modeでキーの認識を見ましょう。
<details><summary>VIAの場合</summary>SettingsからShow Design Tabをオンにします。Design > Load Draft Definition からinfo-****.jsonをロードして使用します。Key Tester > Test Matrix でTest Matrix Modeに移動できます。</details>  
<details><summary>ReMapの場合</summary>キーボードを接続した時点で.jsonファイルを要求されます。info-****.jsonをロードして使用してください。  右下の三点メニューからTest Matrix Modeを起動できます。</details>
単独で認識がおかしいキーがあった場合はスイッチの足が曲がっていないか、スイッチソケットの足とダイオードははんだづけされているか、ダイオードの向きは合っているかを確認します。  
列単位・行単位で反応しない場合はPro Microとソケット部のはんだを確認してください。  

すべてのキーに間違いなく反応したら、このキーボードは入力機器として認識できる状態になっています。

## バックパネルの取付け
![ほとんど完成です](img/backpanel.jpg)  
バックパネルを基板の裏に載せ、ネジで固定します。

## ゴム足の取付け
![角度を調整しましょう](img/rubbersole.jpg)
パネルの表示に合わせてゴム足を取り付けます。

# マッピングガイド
キーマップの書き換えにはReMapを使用します。日本語配列にも対応しているため使いやすいと思います。  

## 初期状態
デフォルトで設定されているのはJIS配列を踏襲した配置となっており、通常のJISキーボードからの移行でも違和感なく使用できるはずです。  

Fnキーを押したときの挙動はレイヤーとして扱っています。初期状態では1から^までのキーにF1からF12を割り振り、さらにBackspaceにDeleteを設定している状態です。  
左上のエリア、Esc以外の4キーは初期状態ではバックライト関連のキーを設定しています。  
左から、「色相変更」「彩度上昇」「光量上昇」「オンオフ切り替え」となり、Shift押下時はそれぞれ「色相変更(逆方向)」「彩度下降」「光量下降」「オンオフ切り替え」として機能します。  
Fnを押しながら一番右のキーを押すと点灯モードが切り替わります。
## 書き換え
「スイッチの確認」と同じ手順でReMapに接続し、変更したいキーを選択して書き換えます。
